<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Prediksi Gagal Bayar Kartu Kredit (ANN)</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>
  <div class="container mt-5 mb-5">

    <!-- JUDUL -->
    <div class="text-center mb-4">
      <button class="btn-title-neon title-button">
        üí≥ Prediksi Gagal Bayar Kartu Kredit Menggunakan Artificial Neural Network pada Dataset Default Credit Clients üí≥
      </button>
      <p class="text-light mt-3">
        Pilih data dari dataset menggunakan dropdown. Form akan terisi otomatis, lalu klik <b>Prediksi Sekarang</b>.
      </p>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-danger text-center fw-bold">
          {{ messages[0] }}
        </div>
      {% endif %}
    {% endwith %}

    <!-- FORM -->
    <div class="card shadow-lg p-4 border-0 rounded-4">
      <h4 class="text-light mb-3">üìù Input Data Nasabah</h4>
      <p class="text-secondary mb-4">
        Pilih baris dataset agar data terisi otomatis. Field numerik yang kosong akan dianggap <b>0</b>.
        Kategori (<b>SEX</b>, <b>EDUCATION</b>, <b>MARRIAGE</b>) mengikuti isi dataset.
      </p>

      <form method="POST" action="{{ url_for('predict') }}" class="row g-3">

        <!-- DROPDOWN DATASET -->
        <div class="col-12">
          <label class="form-label text-light">Pilih Data dari Dataset</label>
          <select name="dataset_row" id="dataset_row" class="form-select" required>
            <option value="" disabled {% if selected_row=='' %}selected{% endif %}>-- Pilih salah satu baris dataset --</option>
            {% for opt in dataset_options %}
              <option value="{{ opt.row_key }}" {% if selected_row == (opt.row_key|string) %}selected{% endif %}>
                {{ opt.display }}
              </option>
            {% endfor %}
          </select>
          <small class="text-secondary">
            Setelah dipilih, semua field akan terisi otomatis sesuai dataset.
          </small>
        </div>

        <hr class="border-secondary mt-4">

        <!-- LIMIT_BAL -->
        <div class="col-md-6">
          <label class="form-label text-light">LIMIT_BAL</label>
          <input type="number" step="any" min="0" name="LIMIT_BAL" class="form-control"
                 placeholder="Contoh: 200000" value="{{ values.get('LIMIT_BAL','') }}">
        </div>

        <!-- SEX -->
        <div class="col-md-6">
          <label class="form-label text-light">SEX</label>
          <select name="SEX" class="form-select" required>
            <option value="" disabled {% if values.get('SEX','')=='' %}selected{% endif %}>-- Pilih --</option>
            <option value="1" {% if values.get('SEX','')=='1' %}selected{% endif %}>1 - Pria</option>
            <option value="2" {% if values.get('SEX','')=='2' %}selected{% endif %}>2 - Wanita</option>
          </select>
        </div>

        <!-- EDUCATION -->
        <div class="col-md-6">
          <label class="form-label text-light">EDUCATION</label>
          <select name="EDUCATION" class="form-select" required>
            <option value="" disabled {% if values.get('EDUCATION','')=='' %}selected{% endif %}>-- Pilih --</option>
            <option value="1" {% if values.get('EDUCATION','')=='1' %}selected{% endif %}>1 - Graduate School</option>
            <option value="2" {% if values.get('EDUCATION','')=='2' %}selected{% endif %}>2 - University</option>
            <option value="3" {% if values.get('EDUCATION','')=='3' %}selected{% endif %}>3 - High School</option>
            <option value="4" {% if values.get('EDUCATION','')=='4' %}selected{% endif %}>4 - Others</option>
          </select>
        </div>

        <!-- MARRIAGE -->
        <div class="col-md-6">
          <label class="form-label text-light">MARRIAGE</label>
          <select name="MARRIAGE" class="form-select" required>
            <option value="" disabled {% if values.get('MARRIAGE','')=='' %}selected{% endif %}>-- Pilih --</option>
            <option value="1" {% if values.get('MARRIAGE','')=='1' %}selected{% endif %}>1 - Menikah</option>
            <option value="2" {% if values.get('MARRIAGE','')=='2' %}selected{% endif %}>2 - Lajang</option>
            <option value="3" {% if values.get('MARRIAGE','')=='3' %}selected{% endif %}>3 - Lainnya</option>
          </select>
        </div>

        <!-- AGE -->
        <div class="col-md-6">
          <label class="form-label text-light">AGE</label>
          <input type="number" step="any" min="0" name="AGE" class="form-control"
                 placeholder="Contoh: 29" value="{{ values.get('AGE','') }}">
        </div>
        <div class="col-md-6"></div>

        <!-- PAY -->
        <h6 class="text-info mt-4">Riwayat Pembayaran (PAY)</h6>
        <p class="text-secondary mb-2">
          Catatan: Nilai PAY bisa negatif (mis. -1, -2) sesuai definisi dataset.
        </p>

        {% for col in ["PAY_0","PAY_2","PAY_3","PAY_4","PAY_5","PAY_6"] %}
        <div class="col-md-4">
          <label class="form-label text-light">{{ col }}</label>
          <input type="number" step="any" name="{{ col }}" class="form-control"
                 value="{{ values.get(col,'') }}">
        </div>
        {% endfor %}

        <!-- BILL -->
        <h6 class="text-info mt-4">Tagihan (BILL_AMT)</h6>
        {% for col in ["BILL_AMT1","BILL_AMT2","BILL_AMT3","BILL_AMT4","BILL_AMT5","BILL_AMT6"] %}
        <div class="col-md-4">
          <label class="form-label text-light">{{ col }}</label>
          <input type="number" step="any" name="{{ col }}" class="form-control"
                 value="{{ values.get(col,'') }}">
        </div>
        {% endfor %}

        <!-- PAY_AMT -->
        <h6 class="text-info mt-4">Pembayaran (PAY_AMT)</h6>
        {% for col in ["PAY_AMT1","PAY_AMT2","PAY_AMT3","PAY_AMT4","PAY_AMT5","PAY_AMT6"] %}
        <div class="col-md-4">
          <label class="form-label text-light">{{ col }}</label>
          <input type="number" step="any" min="0" name="{{ col }}" class="form-control"
                 value="{{ values.get(col,'') }}">
        </div>
        {% endfor %}

        <div class="col-12 text-center mt-4">
          <button type="submit" class="btn btn-primary btn-lg px-5">
            Prediksi Sekarang
          </button>
          <a href="{{ url_for('home') }}" class="btn btn-outline-light btn-lg px-4 ms-2">Reset</a>
        </div>

      </form>
    </div>

    <!-- HASIL -->
    <div class="card shadow-lg p-4 border-0 rounded-4 mt-4">
      <h4 class="text-light mb-3">üìå Hasil</h4>

      {% if result %}

        <!-- Ground Truth dari Dataset -->
        <div class="alert text-center fw-bold {% if result.true_y == 1 %}alert-danger{% else %}alert-success{% endif %}">
          Label Asli Dataset (Baris #{{ result.row_key + 1 }}): <b>{{ result.true_label }}</b> ({{ result.true_y }})
        </div>

        <!-- Prediksi model -->
        <div class="p-3 rounded-3 bg-dark text-light mb-3">
          <div class="mb-1">
            Prediksi Model ANN: <b>{{ result.model_label }}</b> ({{ result.model_pred }})
          </div>
          <div class="text-secondary">
            Probabilitas gagal bayar (model): <b>{{ (result.prob * 100) | round(2) }}%</b>
            ‚Ä¢ Threshold: <b>{{ result.threshold }}</b>
          </div>
        </div>

        <!-- Progress bar probabilitas model -->
        <div class="progress mb-3" style="height: 18px;">
          <div class="progress-bar {% if result.model_pred == 1 %}bg-danger{% else %}bg-success{% endif %}"
               role="progressbar"
               style="width: {{ (result.prob * 100) | round(2) }}%;">
            {{ (result.prob * 100) | round(2) }}%
          </div>
        </div>

        <!-- Catatan interpretasi -->
        <div class="p-3 rounded-3 bg-dark text-light">
          <b>Catatan:</b> Label dataset adalah ‚Äújawaban asli‚Äù. Prediksi model bisa berbeda karena model tidak selalu 100% akurat.
        </div>

      {% else %}
        <div class="text-secondary">
          Belum ada hasil. Pilih data dari dropdown lalu klik <b>Prediksi Sekarang</b>.
        </div>
      {% endif %}
    </div>

    <div class="text-center text-secondary mt-4">
      ¬© 2025 | TA-11 ‚Äî ANN Credit Default Prediction (Flask)
    </div>

  </div>

  <!-- Auto-fill dari dataset -->
  <script>
    async function loadDatasetRow(rowKey) {
      const res = await fetch(`/row/${rowKey}`);
      const data = await res.json();
      if (!data.ok) return;

      for (const [key, val] of Object.entries(data.values)) {
        const el = document.querySelector(`[name="${key}"]`);
        if (el) el.value = val;
      }
    }

    const dsSelect = document.getElementById("dataset_row");
    if (dsSelect) {
      dsSelect.addEventListener("change", (e) => {
        const rowKey = e.target.value;
        if (rowKey !== "") loadDatasetRow(rowKey);
      });

      // jika setelah submit sudah ada pilihan, isi otomatis lagi
      if (dsSelect.value) loadDatasetRow(dsSelect.value);
    }
  </script>
</body>
</html>